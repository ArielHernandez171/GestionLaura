@using GestionLaura.Logica
@using GestionLaura.Clases
@inject IJSRuntime js

@page "/Consumo"

<h3 class="titulo-consumos">Consumos</h3>

<div class="layout-consumos">

    <!-- IZQUIERDA -->
    <div class="consumos-container">        
        <br />

        @if (stocks.Count() != 0)
        {
            <div class="tabla-consumos">
                @foreach (var p in stocks)
                {
                    <div class="fila-consumo">
                        <div class="col producto">@p.Productos</div>
                        <div class="col cantidad-actual">@p.StockProd.Cantidad</div>

                        <EditForm Model="@prodStock" OnSubmit="@(() => Sumar(p.Productos))" class="form-sumar">
                            <input type="number" @bind="@prodStock.Cantidad" class="input-number" />
                            <button type="submit" class="btn-rosa">Sumar</button>
                        </EditForm>
                    </div>
                }
            </div>

            <div class="form-layout">
                <div class="form-left">
                    <EditForm Model="@registro" OnSubmit="@Guardar" class="form-guardar">
                    <div class="form-group">
                        <label>Ingrese Id</label>
                        <input type="number" class="input-number" />   
                    </div>

                    <div class="form-group">
                        <label>Precio Fn</label>
                        <input type="number" class="input-number" />
                    </div>

                    <div class="form-group">
                        <label>Concepto</label>
                        <input type="text" @bind="@registro.Concepto" class="input-text" />
                        <button class="btn-rosa">Guardar</button>
                    </div>
                    </EditForm>
                </div>

                <div class="form-right">
                    <div class="form-group">
                        <label>Servicio Rapido</label>
                        <input type="text" class="input-text" />
                        <button type="submit" class="btn-rosa">Agregar</button>
                    </div>
                </div>
            </div>
        }
        
    </div>

    <!-- DERECHA: CONSUMOS USADOS -->
    <div class="servicios-rapidos">
        <h4>Usado en este servicio</h4>

        @if (consumosUsados.Count == 0)
        {
            <p class="msg-vacio">Todavía no hay consumos</p>
        }
        else
        {
            <ul class="lista-usos">
                @foreach (var c in consumosUsados)
                {
                    <li>@c.Cantidad x @c.Producto</li>
                }
            </ul>
        }
    </div>

</div>





@code {
    private LogServ log = new LogServ();
    private LogProductos logProd = new LogProductos();
    public ProdStock prodStock = new ProdStock();
    public List<Producto> stocks = new List<Producto>();
    public List<Producto> productos = new List<Producto>();
    private RegistroServs registro = new RegistroServs();
    float? i = 0;
    private List<(string Producto, float Cantidad)> consumosUsados = new();

    protected override async Task OnInitializedAsync()
    {
        await logProd.Cargar();
        foreach(Producto pr in logProd.Prod)
        {
            if(pr.Tipo.Equals(Tipo.Promedio)){
                stocks.Add(pr);
            }
            else
            {
                pr.StockProd = new ProdStock();
                pr.StockProd.Cantidad = 0;
                foreach(var P in pr.StocksFIfo){
                    pr.StockProd.Cantidad = pr.StockProd.Cantidad + P.Cantidad;
                }
                stocks.Add(pr);
            }
        }
        await base.OnInitializedAsync();
    }
    protected async void Sumar(string n)
    {
        if (prodStock.Cantidad > stocks.Where(s => s.Productos == n).First().StockProd.Cantidad)
        {
            await js.InvokeVoidAsync("alerta");
            return;
        }

        float cantidadUsada = prodStock.Cantidad ?? 0;
        if (i == null)
            i = 0;
        if (Tipo.Fifo == logProd.Prod.Where(f => f.Productos == n).First().Tipo)
        {
            foreach (var d in logProd.Prod.Where(f => f.Productos == n).First().StocksFIfo)
            {
                i += cantidadUsada * d.Precio;
                if (d.Cantidad < prodStock.Cantidad)
                {
                    prodStock.Cantidad -= d.Cantidad;
                    d.Cantidad = 0;
                }
                else
                {
                    d.Cantidad -= prodStock.Cantidad;
                    break;
                }
            }
        }
        else
        {
            logProd.Prod.Where(r => r.Productos == n).First().RestarProm(prodStock);
            i += cantidadUsada * logProd.Prod.Where(l => l.Productos == n).First().StockProd.Precio;
        }

        // Registrar consumo para mostrar a la derecha
        var existente = consumosUsados.FirstOrDefault(c => c.Producto == n);

        if (existente.Producto != null)
        {
            consumosUsados.Remove(existente);
            consumosUsados.Add((n, existente.Cantidad + cantidadUsada));
        }
        else
        {
            consumosUsados.Add((n, cantidadUsada));
        }


        // CORREGIDO
        registro.Costo += i;

        // limpiar campo visual
        prodStock.Cantidad = 0;

        StateHasChanged();
    }
    protected async Task Guardar()
    {
        
        await log.GuardarServicio(registro);
        await logProd.Guardar();
    }
    
}

